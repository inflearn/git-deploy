#!/bin/bash

# Welcome screen

echo "                                                                                        ";
echo "     ((((((  ((((((                                                                     ";
echo "   (((       (    (((    â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—";
echo " (((   ((,  ((      ((,  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘";
echo " ((       (((        ((  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘";
echo " ((         ((,      ((  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘";
echo "  ((    (((((((((    ((  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘";
echo "   (((           ((( ((  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•";
echo "      (((((((((((((((((                                                                 ";
echo "                                                                                        ";
echo "Git deploy ìë™í™” ìŠ¤í¬ë¦½íŠ¸";
echo ""

# Script to deploy to test branch

usage() {
    err_msg "ì‚¬ìš©ë²•: git-deploy [-h | --help] [-T | --include-test-branch]"
    exit 1
}

exit_on_failed() {
    echo "$@";
    exit 1;
}

err_msg() { echo "$@" ;} >&2

# long ì˜µì…˜ ì²˜ë¦¬
A=""
is_override=0
local_deploy_branch="test"
remote_deploy_branch="origin/test"
working_branch=$(git branch --show-current)
while true; do
    [ $# -eq 0 ] && break
    case $1 in
        --include-test-branch)
            is_override=1
            echo "í˜„ì¬ ë¸Œëœì¹˜ë¥¼ test ë¸Œëœì¹˜ ìœ„ë¡œ ë¦¬ë² ì´ìŠ¤í•œ ë’¤ test ë¸Œëœì¹˜ë¡œ push í•©ë‹ˆë‹¤."
            shift; continue
            ;;
        --help)
            usage
            shift; continue
            ;;
        --*)
            err_msg "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: $1"
            usage;
            ;;
    esac

    A=$A$([ -n "$A" ] && echo -e "\a")$1
    shift
done

# $@' ê°’ì— short ì˜µì…˜ë§Œ ë‚¨ê¸°ê¸°
IFS=$(echo -e "\a"); set -f; set -- $A; set +f; IFS=$(echo -e " \n\t")

# short ì˜µì…˜ ì²˜ë¦¬
while getopts "Th" opt; do
    case $opt in
        T)
            is_override=1
            usage
            echo "í˜„ì¬ ë¸Œëœì¹˜ë¥¼ test ë¸Œëœì¹˜ ìœ„ë¡œ ë¦¬ë² ì´ìŠ¤í•œ ë’¤ test ë¸Œëœì¹˜ë¡œ push í•©ë‹ˆë‹¤."
            ;;
        h)
            usage
            ;;
        *)
            # err_msg "ì•Œ ìˆ˜ ì—†ëŠ” ì˜µì…˜: -$OPTARG"
            usage
            ;;
    esac
done

shift $(( OPTIND - 1 ))

# Delete $local_deploy_branch with -f option
echo "ğŸ—‘ ë¡œì»¬ $local_deploy_branch ë¸Œëœì¹˜ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."
echo "git branch -D $local_deploy_branch"
git branch -D $local_deploy_branch

echo ""

# Create new branch 'test' and checkout to this
echo "$working_branch ë¸Œëœì¹˜ì—ì„œ ğŸ†• $local_deploy_branch ë¸Œëœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒí•©ë‹ˆë‹¤."
echo "git checkout -b $local_deploy_branch"
git checkout -b $local_deploy_branch || exit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”"

echo ""

# Rebase $local_deploy_branch onto $remote_deploy_branch branch when --include-test-branch option is specified
if [ $is_override -eq 1 ]
  then
  echo "í˜„ì¬ ë¸Œëœì¹˜($local_deploy_branch)ë¥¼ $remote_deploy_branch ë¸Œëœì¹˜ ìœ„ë¡œ ë¦¬ë² ì´ìŠ¤í•©ë‹ˆë‹¤."
  echo "git rebase $remote_deploy_branch"
  git fetch
  git rebase $remote_deploy_branch || exit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”"

  echo ""
fi

# Push local branch onto the remote branch with -f option
echo "ğŸ†™ ë¡œì»¬ $local_deploy_branch ë¸Œëœì¹˜ë¥¼ ë¦¬ëª¨íŠ¸ë¡œ ê°•ì œ í‘¸ì‹œí•©ë‹ˆë‹¤."
echo "git push -f origin $local_deploy_branch"
git push -f origin $local_deploy_branch || exit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”"

echo ""

# Checkout back to initial branch

echo "ğŸ†— ì‹œì‘ ë¸Œëœì¹˜ë¡œ ëŒì•„ì˜µë‹ˆë‹¤."
echo "git checkout $working_branch"
git checkout "$working_branch" || exit_on_failed "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë¬¸ì œë¥¼ í•´ê²°í•˜ê³  ë‹¤ì‹œ ì‹œë„í•˜ê±°ë‚˜ ìˆ˜ë™ìœ¼ë¡œ ì§„í–‰í•´ì£¼ì„¸ìš”"

echo ""

# Delete 'test' branch

echo "ğŸ†“ $local_deploy_branch ë¸Œëœì¹˜ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."
echo "git branch -D $local_deploy_branch"
git branch -D "$local_deploy_branch"

echo ""

# Bye!

echo "ğŸ‘½ ì•ˆë…•!"
